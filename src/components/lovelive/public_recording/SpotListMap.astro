---
import { getCollection, type CollectionEntry } from 'astro:content';
import DefaultPageLayout from '$/layouts/default.astro';
import PostPreviewList from '$/components/PostPreviewList.astro';
import MapViewer from '$/components/PhotoMapViewer.astro';

interface Props {
  title: string;
  description: string;
  /** additional に含めたい文字列（例: 'kouroku_lunch'） */
  additionalKey: string;
  /** 無条件で地図に含めたい slug 群（例外） */
  includeSlugs?: string[];
  /** リスト側は additional 該当だけにするか（あなたの現仕様） */
  listOnlyAdditional?: boolean;
  /** 地図の高さ */
  mapHeight?: string;
  /** 地図のズーム */
  zoom?: number;
}

const IncludeSlugs = ['central_center', 'station'];
const {
  title,
  description,
  spotList,
  mapHeight = '380px',
} = Astro.props as Props;
const allSpotList = [...IncludeSlugs, ...spotList];

// 1) 全件取得
const raw_all = await getCollection('spot_note');
const all = raw_all.sort((a, b) => a.data.furigana.localeCompare(b.data.furigana, 'ja', { sensitivity: 'base' }));

// 2) リスト：spotList 該当 → lat/lng 必須
const filtered = all
  .filter(
    (p) => allSpotList.includes(p.slug)
  )
  .filter((p) => p.data.lat && p.data.lng);

// 3) MapViewer 用の整形
const places = filtered
  .map((p) => ({
    title: 
      p.slug == 'central_center'
        ? '公録会場'
        : p.data.title,
    lat: p.data.lat,
    lng: p.data.lng,
    icon: 
      p.data.icon 
         ? `/images/icon_photo/${p.slug}.jpg`
         : 'undefined',
    url: `/spot_note/${p.slug}`,
    gmap: p.data.gmap,
    addPopup: IncludeSlugs.includes(p.slug),
  }))
---

<DefaultPageLayout content={{ title, description }}>
  <!-- トップページへの案内ボタン -->
  <div class="mb-6">
    <a
      href="/lovelive/public_recording"
      class="inline-block bg-purple-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-purple-700 transition"
    >
      公録トップページはこちら
    </a>
  </div>

  <!-- リスト（CollectionEntry配列をそのまま） -->
  <PostPreviewList posts={filtered} />
  <br>

  <!-- 地図 -->
  <MapViewer places={places} height={mapHeight} center = {[35.97828774067374, 140.14775381176043]} />
</DefaultPageLayout>

